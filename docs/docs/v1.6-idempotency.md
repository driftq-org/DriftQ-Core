# DriftQ v1.6 — Idempotency + “Exactly-once-ish effects” (Semantics)

## Goal (what we guarantee)
DriftQ v1.6 does **not** guarantee exactly-once delivery.
It guarantees **exactly-once-ish side effects at the worker boundary** *when the worker uses the idempotency helper*.

Meaning:
- A message may be delivered more than once (at-least-once).
- But the worker can ensure it does not execute the same side effect twice by using an idempotency key.

## Scope / identity of an idempotent operation
An idempotent operation is identified by:

- `tenant_id`
- `idempotency_key`

So the effective idempotency identity is: **(tenant_id, idempotency_key)**.

Notes:
- If `tenant_id` is empty, treat it as `"default"` for v1.
- If `idempotency_key` is empty, **no idempotency is applied**.

## Worker contract (required usage)
To get “exactly-once-ish effects”, a worker MUST:

1) Check the idempotency store before executing side effects.
2) If the key is already marked **SUCCESS**, the worker must **skip execution** and reuse the stored result/status.
3) If the key is **IN_PROGRESS** (optional in v1), the worker may:
   - either wait/return a retryable error
   - or treat as “already running elsewhere” and skip
4) If no record exists, the worker executes the side effect and then records:
   - SUCCESS + result (minimal result is fine for v1)
   - or FAILURE + error info (for retries/DLQ)

## What is stored (minimal v1)
For each (tenant_id, idempotency_key), DriftQ stores:

- `status`: SUCCESS | FAILURE | (optional) IN_PROGRESS
- `result`: optional small payload (string/bytes or JSON)
- `last_error`: optional string (for FAILURE)
- `updated_at`: timestamp

Persistence:
- In v1.6, this may be **in-memory only**.
- WAL persistence of idempotency state can be added later.

## Interaction with retries / redelivery
- Redelivery can cause duplicate deliveries.
- If `idempotency_key` is set and the worker uses the helper:
  - a redelivered message with the same key should not cause duplicate side effects.
- Retry policy controls how many attempts DriftQ should try before DLQ.

## Interaction with DLQ
If a message exceeds retry policy (attempts > max_attempts), DriftQ routes it to a DLQ topic.
DLQ messages should include metadata:
- original topic / partition / offset
- attempts
- last_error
- tenant_id + idempotency_key
