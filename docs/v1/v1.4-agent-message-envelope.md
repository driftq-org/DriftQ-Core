# DriftQ v1.4 — Agent message envelope (run/step IDs + routing metadata) (Semantics)

This document defines the **v1.4 contract** for DriftQ’s message envelope and routing metadata. The envelope is how DriftQ becomes “agent-native”: it carries workflow identity, routing controls, and policy knobs alongside the message payload.

## What we guarantee (and what we don’t)

Guaranteed / intended behavior:
- A message may include an optional **Envelope** that carries workflow/agent metadata.
- Envelope fields are treated as **metadata** (they do not change the payload bytes).
- The broker preserves the envelope on delivery (and when WAL is enabled, persists supported fields).
- The broker supports basic routing controls via the envelope:
  - `target_topic` (topic override)
  - `partition_override` (force a specific partition)
- The broker attaches optional **routing metadata** (label + meta map) to the message when a router is configured.

Not guaranteed in v1.4:
- any enforcement of labels (labels are informational only)
- authz/governance policies (tenant is carried but not enforced)
- schema validation beyond basic parsing/typing
- durable “exactly-once” semantics (handled in v1.6 via idempotency at the worker boundary)

## Envelope fields (v1.4)

### Workflow identity
- `run_id`: identifier for an agent run / workflow execution
- `step_id`: identifier for a step/task within the run
- `parent_step_id`: optional parent step identifier for lineage

Intended use:
- tracing agent pipelines
- correlating retries to the same workflow step
- building “workflow-aware” tooling later (replay, observability, governance)

### Labels
- `labels`: map of arbitrary key/value labels

Intended use:
- tagging (environment, model, priority, customer, feature flags)
- future policy routing / filtering / observability

### Routing controls
- `target_topic`: if set, the broker routes the message to this topic instead of the producer-requested topic.
- `partition_override`: if set, the broker routes to that partition index (must be in range).

Priority:
- If a router is configured, router decisions may overwrite these routing controls (router “wins” for MVP).

### Reliability / policy knobs (carried in v1.4)
v1.4 introduces these fields on the envelope so later milestones can use them:

- `idempotency_key` (used in v1.6 for dedupe)
- `deadline` (reject produce if already expired; used for time-bounded work)
- `retry_policy` (used in v1.6 for retry scheduling)
- `tenant_id` (carried now for future governance/multi-tenancy)

Note: In v1.4, these fields may be present even if not fully enforced beyond basic behavior.

## Routing metadata (router output)

If a router is configured, the broker can attach routing metadata to a message:
- `routing.label`: high-level label for observability/policy
- `routing.meta`: arbitrary string map for extra metadata (scores, source, etc.)

This metadata is informational in v1.4 and should not be relied on for correctness.

## How envelope interacts with produce/consume

### Produce
- Producer sends `topic`, `key`, `value`, and optionally `envelope`.
- Broker determines the **final topic**:
  - default: the producer’s `topic`
  - overridden by `envelope.target_topic` if set (unless router overrides it)
- Broker determines the **partition**:
  - default: hash(key) % N (or partition 0 if key empty)
  - overridden by `envelope.partition_override` if set (unless router overrides it)

### Consume
- Consumer receives the message payload plus:
  - `partition`, `offset`, `attempts`
  - `envelope` (if present)
  - `routing` (if present)

## Durability notes (WAL)

When WAL is enabled, supported envelope fields are persisted with the message record so they can be restored on replay.
(Exact field coverage depends on the current WAL entry schema. v1.4 contract is that envelope fields are preserved across delivery; durability is “best-effort per supported fields” until the WAL schema is extended.)

## Non-goals for v1.4

- enforcing tenant governance / quotas
- priority scheduling based on labels
- policy-based routing beyond basic router hook (v1.5)
- DLQ behavior (later milestone)
- schema registry / typed message envelopes

## Example envelope

```json
{
  "run_id": "run_123",
  "step_id": "step_7",
  "parent_step_id": "step_3",
  "labels": { "env": "dev", "team": "finance-agent" },
  "tenant_id": "tenant_a",
  "target_topic": "tasks.enrich",
  "partition_override": 1,
  "idempotency_key": "tenant_a:run_123:step_7",
  "deadline": "2025-12-21T12:00:00Z",
  "retry_policy": { "max_attempts": 5, "backoff_ms": 250, "max_backoff_ms": 5000 }
}
```

## Example flow (agent pipeline)

1) Agent orchestrator produces a message with `run_id` and `step_id` for “summarize report”.
2) Router labels it `routing.label="summarization"` with `meta={"model":"gpt-4.1"}`.
3) Worker consumes it, uses `run_id/step_id` for tracing, and processes it.
4) On failure, retry policy + idempotency (v1.6) ensure safe retries without double side effects.
